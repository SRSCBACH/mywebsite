<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streckenkatalog - SRSC Bach</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">

    <style>
        :root {
            --bg-card-route: rgba(15, 34, 51, 0.6); 
            --border-color: rgba(255, 255, 255, 0.1); 
            --btn-bg: rgba(255, 255, 255, 0.1);
            --accent-blue: #0055ff;
        }

        html, body { 
            height: 100%; margin: 0; padding: 0; 
            overflow: hidden; background-color: #0f172a;
        }

        body { display: flex; flex-direction: column; perspective: 1200px; }

        /* WALZEN-CONTAINER OPTIMIERT */
        #app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            /* Padding sorgt dafür, dass die erste und letzte Karte mittig landen können */
            padding: 35vh 0; 
            scrollbar-width: none;
            box-sizing: border-box;
        }
        #app-container::-webkit-scrollbar { display: none; }

        .card {
            background-color: var(--bg-card-route);
            border-radius: 20px; 
            border: 1px solid var(--border-color); 
            padding: 20px; 
            width: 90%; max-width: 900px;
            backdrop-filter: blur(15px);
            margin-bottom: 10vh; /* Abstand zwischen den Walzenelementen */
            scroll-snap-align: center;
            
            /* Walzen-Effekt: Standardzustand (Unscharf/Klein) */
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            opacity: 0.2;
            transform: scale(0.8) rotateX(20deg);
            filter: blur(4px);
        }

        /* Aktive Karte (In der Mitte) */
        .card.active {
            opacity: 1;
            transform: scale(1) rotateX(0deg);
            filter: blur(0px);
            box-shadow: 0 20px 60px rgba(0, 85, 255, 0.25);
            border-color: rgba(0, 85, 255, 0.4);
        }

        /* Content Layout */
        .header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .title { font-size: 1.6rem; color: #fff; margin: 0; }
        .content-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .map-wrapper { height: 250px; background: #e2e8f0; border-radius: 12px; overflow: hidden; }
        .profile-container { height: 120px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-top: 10px; padding: 10px; }
        
        .data-table { display: flex; flex-direction: column; gap: 8px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0; }
        .data-label { color: #94a3b8; font-size: 0.9rem; }
        .data-value { color: #fff; font-weight: 700; font-size: 1.2rem; }

        .button-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 10px; background: var(--btn-bg); color: #fff; border-radius: 8px; text-align: center; text-decoration: none; border: 1px solid var(--border-color); font-weight: bold; font-size: 0.8rem; }
        .btn:hover { background: #334155; }

        @media (max-width: 800px) {
            .content-grid { grid-template-columns: 1fr; }
            .card { width: 92%; }
        }
    </style>
</head>
<body>

    <header class="header-container" id="header-container"></header>

    <div class="background-animation">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <main id="app-container"></main>

    <footer class="footer-container" id="footer-container"></footer>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="main.js"></script>
    
    <script>
        const customFont = "'Eloquia Text ExtLt', sans-serif";
        Chart.defaults.font.family = customFont;
        Chart.defaults.color = '#cbd5e1';

        // 1. Daten laden
        fetch('strecken.json')
            .then(res => res.json())
            .then(touren => {
                const container = document.getElementById('app-container');
                touren.forEach(tour => {
                    if(tour.active !== false) {
                        createCardHTML(container, tour.id);
                        setTimeout(() => initSingleCard(tour.id, tour, customFont), 0);
                    }
                });
                setupIntersectionObserver(); // Modernes Fokus-System
            });

        function createCardHTML(container, id) {
            const html = `
            <div class="card" id="card-${id}">
                <div class="header">
                    <h2 class="title" id="title-${id}">Lade...</h2>
                    <img src="https://static.wixstatic.com/shapes/9627cc_826a93d178b649dbb134b4376c5e88ee.svg" style="height:20px; opacity:0.5;">
                </div>
                <div class="content-grid">
                    <div class="left-column">
                        <div id="map-${id}" class="map-wrapper"></div> 
                        <div class="profile-container"><canvas id="chart-${id}"></canvas></div>
                    </div>
                    <div class="right-column">
                        <div class="data-table">
                            <div class="data-row"><span>Distanz</span><span id="dist-${id}">...</span></div>
                            <div class="data-row"><span>Höhenmeter</span><span id="elev-${id}">...</span></div>
                            <div class="data-row"><span>Profil</span><span id="prof-${id}">...</span></div>
                        </div>
                        <div class="button-group">
                            <a id="btn-gpx-${id}" href="#" class="btn">GPX</a>
                            <a id="btn-komoot-${id}" href="#" class="btn">Komoot</a>
                        </div>
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }

        // 2. MODERNES FOKUS-SYSTEM
        function setupIntersectionObserver() {
            const options = {
                root: document.getElementById('app-container'),
                threshold: 0.6 // Karte muss zu 60% sichtbar sein, um aktiv zu werden
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('active');
                    } else {
                        entry.target.classList.remove('active');
                    }
                });
            }, options);

            // Kurz warten, bis Karten generiert sind, dann beobachten
            setTimeout(() => {
                document.querySelectorAll('.card').forEach(card => observer.observe(card));
            }, 500);
        }

        // 3. GPX & LOGIK (Vereinfacht für Stabilität)
        function initSingleCard(id, data, font) {
            if(data.gpx) document.getElementById(`btn-gpx-${id}`).href = data.gpx;
            if(data.komoot) document.getElementById(`btn-komoot-${id}`).href = data.komoot;

            let map = L.map(`map-${id}`, { zoomControl: false });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            if(data.gpx) {
                new L.GPX(data.gpx, { async: true, polyline_options: { color: '#0055ff', weight: 4 } })
                .on('loaded', e => {
                    const g = e.target;
                    map.fitBounds(g.getBounds());
                    document.getElementById(`title-${id}`).innerText = g.get_name().replace(/\.gpx$/i, '');
                    document.getElementById(`dist-${id}`).innerText = (g.get_distance()/1000).toFixed(1) + " km";
                    document.getElementById(`elev-${id}`).innerText = g.get_elevation_gain().toFixed(0) + " hm";
                    
                    const ratio = g.get_elevation_gain() / (g.get_distance()/1000);
                    document.getElementById(`prof-${id}`).innerText = ratio > 15 ? "Bergig" : (ratio > 8 ? "Wellig" : "Flach");
                    
                    renderChart(id, g.get_elevation_data(), font);
                }).addTo(map);
            }
        }

        function renderChart(id, data, font) {
            const ctx = document.getElementById(`chart-${id}`).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d[0].toFixed(1)),
                    datasets: [{ data: data.map(d => d[1]), borderColor: '#10b981', fill: true, backgroundColor: 'rgba(16, 185, 129, 0.1)', pointRadius: 0 }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { ticks: { font: { size: 8 } } } }
                }
            });
        }
    </script>
</body>
</html>
